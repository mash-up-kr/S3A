# 13. 실무에서의 도메인 주도 설계 

DDD의 혜택을 가장 많이 받을 수 있는 프로젝트 : 브라운필드 프로젝트 
- 비즈니스 가능성 입증
- 축적된 기술 부채
- 설계 엔트로피에 맞서 대대적인 변화가 필요한 프로젝트 

## 전략적 분석

### 비즈니스 도메인 이해하기 
- 비즈니스 도메인 파악
- 도메인 확대하여 조직이 상위 목표인 하위 도메인을 달성하기 위해 사용하는 비즈니스 구성요소 찾기 
- 부서와 기타 조직 단위 활용하기 

### 핵심 하위 도메인 
- 핵심 하위 도메인을 식별하는 또 하나의 강력한 휴리스틱 : 커다란 진흙 덩어리 찾기 

### 일반 하위 도메인 
- 상용 솔루션, 구독, 연동할 수 있는 오픈소스 소프트웨어 찾기 

### 지원 하위 도메인 
- 직접 경쟁 우위를 제공하지 않는 나머지 소프트웨어 컴포넌트 찾기 

### 현재 설계 탐색 
비즈니스 도메인을 하위 시스템으로 분해하는 데 사용하는 경계를 살펴보자 
- 수명주기를 분리할 수 있는 지 검토 

### 전략적 설계 평가 
- 각 상위 수준 컴포넌트에 대해 그것이 어느 비즈니스 하위 도메인을 포함하고 어떤 기술적 설계 의사결정을 내렸는지 확인할 것 

### 전략적 설계 평가 
- 상위 수준 컴포넌트에 대한 지식을 사용하여 이러한 컴포넌트가 바운디드 컨텍스트인 것처럼 현재 설계의 컨텍스트 맵을 차트로 표시할 것 
- 최적이 아닌 전략적 설계 의사결정 예시 
  - 동일한 상위 수준의 컴포넌트에 여러 작업하는 팀
  - 핵심 하위 도메인 중복 구현
  - 하청 회사가 핵심 하위 도메인 구현
  - 등등등
 
 ## 현대화 전략
 기존 시스템 개선에 대한 안전한 접근 방식 : 크게 생각하되 작게 시작할 것 
 - 시스템의 하위 도메인을 나누는 경계를 찾는 것 
 - 비즈니스 하위 도메인 경계를 반영하도록 기술적 구현 패턴이 아닌 바운디드 컨텍스트 모듈로 재구성 
 
 ### 전략적 현대화
 - 논리적 경계를 물리적 경계로 바꿔 바운디드 컨텍스트를 추출하는 과정 
 - 필요한 최소 바운디드 컨텍스트가 있다면 이들 간 관계와 연동 패턴을 조사할 것 
 - 서로 다른 바운디드 컨텍스트에서 작업하는 팀이 어떻게 의사소통 협업하는 지 확인 
   - 사용자-제공자 관계 
   - 충돌 방지 계층
   - 오픈 호스트 서비스
   - 분리형 노선
 
 ### 전술적 현대화
 - 비즈니스 가치와 구현 전략에서 가장 고통스러운 부조화를 찾기 
 
 ### 유비쿼터스 언어 육성 
 - 전제조건 : 비즈니스 도메인 지식과 비즈니스 도메인의 효과적인 모델을 만들 것 
 - 비즈니스 기능에 가장 적합한 비즈니스 로직 구현 패턴 결정 
 - 시스템의 전체 컴포넌트를 스트랭글러 패턴을 통해 점진적 교체 / 기존 솔루션 리펙토링 

### 스트랭글러 패턴 
- 새로운 바운디드 컨텍스트인 스트랭글러를 생성 
- 해당 스트랭글러를 통해 레거시의 기능을 해당 컨텍스트로 마이그레이션 
- 보통 퍼사드 패턴과 함께 사용하여 이후에 퍼사드 제거 
- 각 바운디드 컨텍스트는 별도의 하위 시스템이므로, 서로 다른 바운디드 컨텍스트와 DB를 공유할 수 없다는 원칙 완화 가능 

### 전술적 설계 의사결정 리팩터링
- 작은 점진적 조치가 대규모 재작성보다 안전하다 
  - 따라서 tx 스크립트 또는 액티브 레코드 패턴을 바로 이벤트 소싱 도메인 모델로 리팩토링하지 말것 
  - 효과적인 애그리게이트 경계를 찾는 데 노력 투자 하기 
- 도메인 모델로의 리팩터링이 한 번에 이루어질 수 없음 대신 도메인 모델 패턴의 요소들을 점진적 도입 
  - VO 찾기 
  - 비즈니스 로직 수집 조사 후 트랜잭션 경계 분석 (일관성)

### 전술적 설계 의사결정에 대한 확산 방법
논리로 호소할 것
- 명시적 트랜잭션 경계가 중요한 이유 : 데이터 일관성 보호 
- DB 트랜잭션이 애그리게이트 둘 이상의 인스턴스 수정 불가 이유 : 일관성 경계 확인
- 외부 컴포넌트에서 애그리게이트 상태 직접 수정 불가 이유 : 비즈니스 로직을 함께 배치 및 중복되지 않게 
- 애그리게이트 기능 중 일부를 저장 프로시저로 넘길 수 없는 이유 : 로직 중복 방지 및 sync 를 위해
- 넓은 트랜잭션 범위는 애그리게이트의 복잡성을 증가 / 성능 하락 : 따라서 작은 애그리게이트 경계 유지 
- 이벤트 소싱 대신 이벤트를 로그 파일에 기록 할 수 없는 이유 : 장기적으로 데이터 일관성 깨질 염려 


---
# 14. 마이크로서비스 

## 서비스란 
- 미리 정의된 인터페이스를 사용해 하나 이상의 역량에 접근하기 위한 메커니즘 
- 서비스의 퍼블릭 인터페이스 : 서비스가 노출되는 시스템 영역을 통함 

## 마이크로서비스란 
서비스가 자신의 퍼블릭 인터페이스에 의해 정의되므로, 자신의 마이크로 퍼블릭 인터페이스, 마이크로 프런트 도어에 의해 정의되는 서비스 
- 마이크로 퍼블릭 인터페이스를 통해 단일 서비스 기능과 연ㄷ농하는 다른 시스템 구성요소 쉽게 파악 가능 
- 서비스간 책임의 영역이 줄어들기 때문에, 확장성, 관리 개발 용이성 
- 마이크로서비스는 자신의 DB 내부를 감쌈 

### 서비스형 메서드는 완벽한 마이크로서비스인가 
- 서비스 하나에 단일 퍼블릭 인터페이스라면? 
- 각각의 마이크로서비스 연동에 대해 너무나 많은 협엽과 변경 동기화 필요 -> 진흙 덩어리 된다. 

### 설계 목표
- 서비스는 서로 연동에 관련된 퍼블릭 메서드를 가진 퍼블릭 인터페이스를 만들어야함 
- 따라서 마이크로서비스는 전체적인 시스템에서 보았을 때 서비스는 간단해져도, 전체적으로는 복잡해짐 

### 시스템의 복잡성
- 로컬 복잡성 = 각 개별 마이크로서비스의 복잡성
- 글로벌 복잡성 = 전체 시스템의 복잡성
- 적절한 마이크로서비스 기반 시스템 설게 = 두가지 균형에 대해 최적화 

### 깊은 서비스로서의 마이크로서비스 
- 모듈을 사각형으로 비유할 때 
- 넓은 사각형 = 폭넓은 기능 
- 좁은 사각형 = 더욱 제한된 기능을 통해 간단한 퍼블릭 인터페이스를 가짐 
- 깊은 사각형 = 복잡성이 높음 
- 얕은 사각형 = 복잡성이 낮음 
- 깊은 모듈의 개념은 마이크로서비스 패턴과 다르다. 
  - 마이크로서비스는 물리적인 경계를 나타내고 / 모듈은 논리적, 물리적 경계 모두를 나타냄 
- 얕은 서비스는 마이크로서비스 지향 프로젝트가 실패하는 원인 

시스템을 마이크로서비스로 분해시, 임계치 = 마이크로서비스를 유스케이스에 의해 젖ㅇ의 
- 모놀리식 시스템을 서비스로 분리 => 변경에 드는 비용 감소 
- 임계치를 지나 계속 분해 => 깊은 서비스는 얕은 서비스로 변화 
  - 통합에 대한 변경 비용 증가 / 진흙덩어리로 변화 

## 도메인 주도 설계와 마이크로서비스의 경계 
- 바운디드 컨텍스트 = 모델의 경계 
- 하위 도메인 = 비즈니스 역량의 경계 
- 애그리게이트 / VO = tx 경계 

### 바운디드 컨텍스트 

MS와 BC 의 공통점 
- 모두 물리적 경계 (단일 팀이 소유) 
  - 충돌하는 모델은 인터페이스가 복잡해지므로 MS 불가 
  - 따라서 MS 는 BC 
- 역은 성립 불가 (모든 BC는 MS가 아님) 
- 각 바운디드 컨텍스트는 여러 하위 도메인을 포함할 수 있지만(모델 충돌이 없다면), 결국 MS가 되지 못할 수 있음 
![image](https://user-images.githubusercontent.com/27190617/231477586-803cf4f3-e71e-4416-99c3-6156515ff837.png)

### 애그리게이트 
BC 는 가장 넓은 유효한 경계 / AG는 가능한 좁은 경계 
- AG : 내부 비즈니스 규칙 / 불변성 / 로직의 복잡성을 감싸는 개별적 비즈니스 기능 단위 
- 따라서 MS는 개별 서비스가 아님 
- 개별 서비스는 시스템의 다른 구성요소와 상호작용하는 컨텍스트에서 고려되어야 함 
- AG와 자신의 하위 도메인에 있는 다른 비즈니스 엔티티 관계가 강할수록 얕은 개별 서비스가 된다

### 하위 도메인 
- 비즈니스 도메인 관점 : 하위 도메인 = 비즈니스 역량을 설명
- 기술적 관점 : 하위 도메인 = 응집된 유스케이스 집합 
- 즉, 같은 비즈니스 모델을 사용, 같거나 밀접하게 관련된 데이터 핸들링, 강한 기능 연관성 유지 
- 유스케이스 중 하나에서 비즈니스 요구사항 변경시 다른 UC에서도 영향받을 가능성 높음 
- 하위 도메인에 포함된 UC 응집력이 결과 모델의 깊이를 보장 
- UC를 작은 케이스로 쪼개면 더 복잡한 퍼블릭 인터페이스를 만들고, 모듈은 더욱 얕아진다. 
- 하위 도메인을 MS로 만드는 것이 최적의 솔루션 휴리스틱 

## MS의 퍼블릭 인터페이스 압축하기
도메인 주도 설계는 서비스를 깊게 만드는데도 도움 

### OHS 
OHS : BC의 모델을 시스템의 다른 구성요소와 연동하는데 사용되는 모델과 분리해줌 
- 연동 지향 모델인 공표 언어를 도입시, 글로벌 복잡성 낮춤 
- 공표된 언어는 좀 더 제한된 모델 노출 (연동에 대한 요구사항 구체화) 
- 동일한 로직에 대해 더 간단한 퍼블릭 인터페이스(기능)을 갖게 되어 서비스가 더 깊이 있어지고, 효과적인 MS 설계 기여 

### ACL 
ACL : 다른 바운디드 컨텍스트와 연동할 때 복잡성을 줄여줌  
- ACL : BC를 사용하는 로컬 복잡성과 글로벌 복잡성 모두 줄여줌 
- 연동의 복잡성은 오직 ACL 에서 담당 
- 바운디드 컨텍스트가 제공하는 서비스의 복잡성을 노출하지 않는 연동 지향적 모델로, 사용자는 압축된 퍼블릭 인터페이스와 좀더 편리하게 동작 
