# 11. 진화하는 설계 의사결정
- 환경의 변화는 소프트웨어 설계 의사결정에 영향을 미친다. 
  - 비즈니스 도메인
  - 조직 구조
  - 도메인 지식
  - 성장

## 도메인 변경
비즈니스 하위 도메인 종류 
- 핵심 : 기업이 경쟁 우위를 확보하기 위해 경쟁자와 다르게 수행하는 활동
- 지원 : 회사가 경쟁자와 다르게 하고 있지만 경쟁 우위를 제공하지 않는 활동
- 일반 : 모든 회사가 같은 방식으로 하는 일 

하위 도메인 유형이 전략적 및 전술적 설계 의사결정에 미치는 영향
- 바운디드 컨텍스트의 경계 설계
- 컨텍스트 간 연동 조율
- 복잡한 비즈니스 로직을 다루기 위한 디자인 패턴 

시간이 지나고, 조직 성장 및 발전에 따라 하위 도메인이 다른 유형으로 변경되는 것은 흔한 일 
### 핵심 -> 일반 
경쟁 우위로 간주했던 비즈니스 알고리즘(로직)이 모든 경쟁업체가 사용할 수 있게 될 경우 
- ex) 타사에서 솔루션 제품이 상용화될 경우 

### 일반 -> 핵심 
기존 상용 솔루션을 자체 구현하여 경쟁 우위를 확보할 수 있는 경우 
- ex) AWS 인프라 

### 지원 -> 일반 
사내 솔루션을 오픈 소스 솔루션과 연동할 경우 
- 일반적인 CRUD 인터페이스 / 특별히 복잡한 내용 없는 경우 

### 지원 -> 핵심
회사에서 비용을 줄이거나 추가 수익을 창출하는 방식
- 지원 로직을 최적화하는 방법을 찾은 경우 
- 전조 증상 : 하위 도메인의 비즈니스 로직이 점점 더 복잡해질 때 
  - 수익성 개선 : 핵심 하위 도메인으로 변경
  - 수익성 여파 없음 : 우발적 비즈니스 복잡성

### 핵심 -> 지원 
하위 도메인의 복잡성이 정당화되지 않을 때 발생 
- 복잡성에 비해 수익성이 없는 경우
- 다른 하위 도메인의 개발 지원하는데 필요한 최소한의 로직만 남기고, 불필요한 복잡성을 줄일 수 있음 

### 일반 -> 지원 
오픈소스 솔루션의 통합 과정에서 복잡성 대비 이점이 없는 경우 -> 사내 시스템 의존 

![image](https://user-images.githubusercontent.com/27190617/229782844-e8ef2ad4-5b58-4aff-be20-1a064d772ecd.png)

## 전략적 설계 문제 
- 하위 도메인 변경 = 바운디드 컨텍스트 영향 = 전략적 설계 의사결정 영향 
- 하위 도메인 유형에 따라 적합한 바운디드 컨텍스트 연동 패턴 존재
  - 핵심 하위 도메인 : ACL(모델 보호) / OHS(구현 모델 변경에 대한 사용자보호) 
- 분리형 노선 패턴
  - 지원 하위 도메인 / 일반 하위 도메인에서 사용
  - 만약 핵심 하위 도메인으로 변경되는 경우 
    - 핵심 하위 도메인 복제가 불가능하므로, 연동할 수 밖에 (사용자-제공자 관계) 

## 전술적 설계 문제 
하위 도메인 유형 변경 지표 : 기존의 기술적 설계가 현재 비즈니스 요구를 지원할 수 없는 경우 
- 현 상황에 따라 가장 적합한 설계 방식 선택 및 필요할 때 개선할 줄 알아야 한다

### 트랜잭션 스크립트 -> 액티브 레코드 
- 두 패턴 모두 절차지향 스크립트 사용
- 차이점 : 액티브 레코드 패턴은 복잡성을 자료구조를 사용하여 캡슐화 
- 따라서 **데이터 작업이 어려워지면 액티브 레코드 패턴으로 리팩토링 할 것**
  - 복잡한 자료구조를 통해 액티브 레코드 객체에 캡슐화
  - DB에 직접 접근이 아닌 액티브 레코드를 통해 모델과 구조를 추상화 

### 액티브 레코드 -> 도메인 모델 
레코드 조작에 대해 비즈니스 로직이 점점 더 복잡해지고 불일치 및 중복 사례가 많아질 때 리팩토링

리팩토링 task
- 밸류 오브젝트를 식별하라 
- 자료구조를 분석하고 트랜잭션 경계를 찾아라 (setter를 private으로) 
- 상태 수정이 해당 객체의 경계 내부로 이동할 때 비즈니스 규칙과 불변성 지속을 위해 어떤 계층이 필요한 지 검토하라 
  - 애그리게이트의 좋은 후보 
- 강한 일관성을 유지하는 데 필요한 최소 데이터 찾기 (해당 경계에 따른 계층 분리 및 외부 애그리게이트가 해당 ID 참조할도록) 
- 각 애그리게이트에 대해 루트 / 퍼블릭 인터페이스의 엔드포인트 식별 

### 도메인 모델 -> 이벤트 소싱 도메인 모델 
- 해당 데이터를 직접 수정하는 것이 아닌 수명주기를 나타내는 도메인 이벤트로 모델링 
- 가장 어려운 점 : 기존 애그리게이트 이력 관리 (이력이 없는 상태 -> 이벤트 기반 모델로 마이그레이션) 

### 전환에 필요한 과거 이력 생성 
- 각 애그리게이트를 위한 대략적인 이벤트 스트림 생성 
- 변환된 모델이 생성된 이벤트 스트림을 프로젝션하여 원래 구현과 동일한 상태를 나타나게 함 
- 단점 : 상태 전환의 전체 히스토리는 복구 불가 (이전 이벤트가 몇개 인지 알 수 없음) 

### 마이그레이션 이벤트 모델링
- 과거 이벤트에 대한 지식 부족 인정
- 현재 상태로 이어질 수 있는 모든 이벤트 복구 및 기존 애그리게이트 인스턴스 이벤트 스트림 초기화(ex- `migrated-from-legacy`) 
- 장점 : 과거 데이터 부족함을 명확화 
- 단점 : 레거시 시스템의 흔적이 이벤트 스토어에 기록 
  - ex) CQRS 사용시 항상 마이그레이션 이벤트 고려하여 프로젝션 

## 조직 변화 
조직 구조의 변화는 팀 의사소통 및 협업 수준에 영향 / 바운디드 컨텍스트 통합 방식 변경 작용

### 파트너십 -> 사용자 - 제공자
거리적으로 멀어져 의사소통과 협업이 어려워질 경우 

### 사용자-제공자 -> 분리형 노선
- 팀에 심각한 의사소통 문제가 발생하는 경우 혹은 지리적 / 조직 내부 정치로 통합이 어려운 경우 

## 도메인 지식 
- 시간이 지나면서 비즈니스 핵심 도메인은 기능이 추가되고 엣지 케이스, 불변성, 규칙 등이 발견된다. 
- 도메인 지식 수준에 따라 바운디드 컨텍스트의 경계 설계에 유용한 것 : 휴리스틱 
- 자주 변경되고 로직이 불명확한 경우 바운디드 컨텍스트를 넓계 설계하자 

## 성장
- 성장 : 건강한 신호 / 새로운 기능이 지속적으로 추가되는 것 = 성공적
- 하지만 성장은 커다란 진흙 덩어리가 될 수 있다. 
- 성장에 따른 복잡성을 다루는 기본 원칙 : 우발적 복잡성(오래된 설계의 결정으로 발생하는 복잡성) 식별 및 제거 
- 본질적인/고유한 복잡성은 도메인 주도 설계 도구와 관행으로 관리되어야 한다. 


### 하위 도메인 
- 유용한 경계를 찾기 위해 노력할 것 (비즈니스 가치의 구성요소 식별 및 솔루션 설계 구현) 
- 식별된 하위 도메인 재 확인 및 응집된 유스케이스에서 휴리스틱으로 하위 도메인을 다시 나누기 

### 바운디드 컨텍스트 
- 성장에 따라 바운디드 컨텍스트는 다양한 문제와 관련 로직이 늘어나는 것은 당연 (우발적 복잡성) 
- 특정 문제를 해결하는 데 초점을 맞춘 바운디드 컨텍스트 추출 -> 모델 단순화 하기 

### 애그리게이트 
- 항상 애그리게이트를 작게 유지해라 
- 만약 일관성을 유지할 필요가 없는 데이터까지 포함하여 애그리게이트가 커진다면, 제거하자
- 휴리스틱을 사용하여 비즈니스 로직을 새 애그리게이트로 추출할 수 있는 지 확인할 것 
- 애그리게이트가 작게 유지된다면, 바운디드 컨텍스트 또한 단순해진다. 




# 12. 이벤트스토밍 
- 비즈니스 프로세스에 관해 브레인스토밍, 신속하게 모델링하는 로우테크 모델링 과정 
- 범주(scope) : 참가자가 다룰 비즈니스 프로세스가 존재 
- 모델의 모든 구성 요소가 비즈니스 프로세스의 작동방식을 설명할 때까지 단계별 액터, 커맨드, 외부 시스템 등을 추가하며 개선
- 인원수는 10명이상 되지 않도록, 다양한 배경을 가진 사람일수록 좋음

### 이벤트스토밍 과정 
1.자유로운 탐색 
- 도메인 이벤트를 브레인스토밍 시작 
2.타임라인 (발생순으로 비즈니스 도메인 정리) 
3.고충점 확인(자동화가 필요하거나, 병목구간, 문서 불충분 ...) 
4.중요 이벤트 
- 컨텍스트나 국면이 바뀌는 것을 나타내는 중대한 비즈니스 이벤트 찾기 
5. 커맨드 
- 무엇이 이벤트 또는 이벤트의 흐름을 시작하게 하는지 설명(트랜잭션 롤백, 주문 제출 등) 
- 시스템의 오퍼레이션을 설명하고 도메인 이벤트와 반대로 명령형으로 작성 
- 액터를 추가한다. 
- 주문을 제출한다 (커맨드) / 주문이 생성됐다 (이벤트) 
6. 정책 
- 커맨드에는 관련되ㅑㄴ 액터가 없기 떄문에 커맨드를 실행할 수도 있는 자동화 정책 찾기 
- 특정 의사결정 조건이 만족할 떄만 문제의 커맨드 시작한다면, 그 의사결정 조건을 정책에 명시 
7. 읽기 모델 
- 액터가 커맨드를 실행하는 의사결정을 내릴 떄 사용하는 시각적 데이터 (스크린, 리포트, 알림) 
8. 외부 시스템 
- 외부 시스템 연동 정보 보강 (커맨드 입력 혹은 출력 등) 
9. 애그리게이트 
- 애그리게이트의 개념을 포함하여 모델을 구성한다. 
- 애그리게이트는 커맨드를 받고 이벤트를 생성한다. 
10. 바운디드 컨텍스트 
- 밀접한 애그리게이트 간에 그룹핑을 한다. 
- 해당 그룹은 자연스러운 바운디드 컨텍스트 경계의 후보가 된다. 

### 이벤트스토밍을 사용하는 경우 
- 유비쿼터스 언어 구추갛기 
- 비즈니스 프로세스 모델링하기 
- 새로운 비즈니스 요구사항 탐색하기 
- 도메인 지식 복구하기 
- 존재하는 비즈니스 프로세스의 개선 방법 탐색하기 
- 새로운 팀원의 훈련 
