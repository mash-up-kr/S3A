# 12ì¥ ì—”í„°í”„ë¼ì´ì¦ˆ ì¹´í”„ì¹´ ì•„í‚¤í…ì²˜ êµ¬ì„± ì‚¬ë¡€

## 12.1 ì—”í„°í”„ë¼ì´ì¦ˆìš© ì¹´í”„ì¹´ ì•„í‚¤í…ì²˜ì˜ ê°œìš”

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/d5cb2d14-8920-44d2-9e87-7760de57b257"/>

ğŸ”¼ ì—”í„°í”„ë¼ì´ì¦ˆ í™˜ê²½ì—ì„œ ë¯¸ëŸ¬ ë©”ì´ì»¤ ì‚¬ìš© ì˜ˆì œ
- ì¹´í”„ì¹´ ê°„ì˜ ë°ì´í„° ë¦¬í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ì£¼ë¡œ **ë¯¸ëŸ¬ ë©”ì´ì»¤**ë¥¼ ì‚¬ìš©í•œë‹¤.
- (1) ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì™€ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ ì‚¬ì´ì— ë¦¬í”Œë¦¬ì¼€ì´ì…˜ì´ í•„ìš”í•œ ê²½ìš°ì´ë‹¤.
- (2) ì—¬ëŸ¬ ë°ì´í„° ì„¼í„°ë§ˆë‹¤ ì¹´í”„ì¹´ê°€ ì¡´ì¬í•˜ê³  ì¤‘ì•™ì— ìˆëŠ” ì¹´í”„ì¹´ë¡œ ë°ì´í„°ë¥¼ ëª¨ìœ¼ê¸° ìœ„í•´ ë¦¬í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì´ë‹¤.

<br/>

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/c2cb52a3-611d-43ce-9d86-81a9c3f3ccf7"/>

ğŸ”¼ ì—”í„°í”„ë¼ì´ì¦ˆ í™˜ê²½ì—ì„œ ì¹´í”„ì¹´ì™€ ê°€ì¥ ë§ì´ ì—°ë™ë˜ì–´ ì“°ì´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤
- ì¤‘ì•™ì˜ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ë¡œ í•©ì³ì§„ ë°ì´í„°ëŠ” ì‹¤ì‹œê°„ ì²˜ë¦¬ì™€ ë¶„ì„ì„ ìœ„í•´ ë³„ë„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ì¬ëœë‹¤.
- ì¹´í”„ì¹´ì™€ ì—°ë™í•´ ë§ì´ ì‚¬ìš©ë˜ëŠ” ì˜ˆë¡œ **ì¥ê¸° ê³„íš ë°°ì¹˜**ê°€ ê°€ëŠ¥í•œ í•˜ë‘¡, **ì‹¤ì‹œê°„ ê²€ìƒ‰**ì´ ê°€ëŠ¥í•œ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜, AWSì˜ ëŒ€í‘œì ì¸ **ìŠ¤í† ë¦¬ì§€**ì¸ S3, **ë¹…ë°ì´í„°**ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì½ê³  ì“¸ ìˆ˜ ìˆëŠ” HBase ë“±ì´ ìˆë‹¤.
- ê° ì• í”Œë¦¬ì¼€ì´ì…˜ë§ˆë‹¤ ê°ê¸° ë‹¤ë¥¸ ì»¨ìŠˆë¨¸ê°€ í•„ìš”í•˜ë‹¤. (for ì¹´í”„ì¹´ì˜ ë°ì´í„°ë¥¼ ì ì¬í•˜ê¸° ìœ„í•œ í† í”½ ì»¨ìŠ˜)

<br/>

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/b1ba5afe-d99e-491a-8c5b-cd0fd5b9496c"/>

ğŸ”¼ ì¹´í”„ì¹´ ì—”í„°í”„ë¼ì´ì¦ˆ í™˜ê²½ êµ¬ì„±ë„
- ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ëŠ” ì´ 2ê°œ(ì—…ìŠ¤íŠ¸ë¦¼ í´ëŸ¬ìŠ¤í„°, ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ í´ëŸ¬ìŠ¤í„°)ë¡œ, **ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ëŠ” ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¥¼ ë¯¸ëŸ¬ë§**í•œë‹¤.
- ì¹´í”„ì¹´ ê°„ì˜ ë¯¸ëŸ¬ë§ì„ ìœ„í•´ ì¹´í”„ì¹´ ì»¤ë„¥íŠ¸ ê¸°ë°˜ì˜ **ë¯¸ëŸ¬ ë©”ì´ì»¤ 2.0**ì´ ë™ì‘í•œë‹¤.
- ì–‘ìª½ì˜ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ëŠ” íš¨ìœ¨ì ì¸ ìŠ¤í‚¤ë§ˆ ê´€ë¦¬ë¥¼ ìœ„í•´ **ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬**ë¥¼ ì‚¬ìš©í•œë‹¤.
- ë°ì´í„°ì˜ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
  - `í”„ë¡œë“€ì„œ-1`ì´ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤. (ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì‚¬ìš©)
  - `ì»¨ìŠˆë¨¸-1`ì€ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì½ëŠ”ë‹¤. (`í”„ë¡œë“€ì„œ-1`ê³¼ ë™ì¼í•œ ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ìš©)
  - `í”„ë¡œë“€ì„œ-1`ì„ ì´ìš©í•´ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€ë“¤ì€ ë¯¸ëŸ¬ ë©”ì´ì»¤ 2.0ì„ í†µí•´ ë‹¤ìš´ ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ë¯¸ëŸ¬ë§ëœë‹¤.
  - ì‹¤ì‹œê°„ ë¶„ì„ì„ ìœ„í•´ `ì»¨ìŠˆë¨¸-2`ê°€ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì½ì€ ë’¤ `ì—˜ë¼ìŠ¤í‹±ì„œì¹˜`ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
    - ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì—ì„œ ì œê³µí•˜ëŠ” REST API ë˜ëŠ” `í‚¤ë°”ë‚˜`ë¥¼ í†µí•´ ê´€ë¦¬ìëŠ” ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
   
- ê´€ë¦¬ ë˜ëŠ” ëª¨ë‹ˆí„°ë§ ì¸¡ë©´ì—ì„œ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì™€ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ëŠ” `CMAK`ë¥¼ ì´ìš©í•´ ì¹´í”„ì¹´ì˜ í† í”½ë“¤ì„ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.
  - ì–‘ìª½ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ë“¤ì—ì„œ ë°œìƒí•˜ëŠ” ë©”íŠ¸ë¦­ë“¤ì´ `í”„ë¡œë©”í…Œìš°ìŠ¤`ì— ì €ì¥ëœë‹¤.
  - ê´€ë¦¬ìëŠ” `ê·¸ë¼íŒŒë‚˜`ë¥¼ í†µí•´ ê·¸ë˜í”„ í˜•íƒœë¡œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆë‹¤.
 
<br/>

## 12.2 ì—”í„°í”„ë¼ì´ì¦ˆìš© ì¹´í”„ì¹´ì˜ í™˜ê²½ êµ¬ì„±

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/49151e89-c9dc-4c8a-ac20-b4fabf3534f5"/>

ğŸ”¼ ì„œë²„ë³„ë¡œ ì‹¤í–‰ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜
- í•„ìš”í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
  - ì£¼í‚¤í¼
  - ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° 2ê°œ
  - ì¹´í”„ì¹´ ì»¤ë„¥íŠ¸
  - ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬
  - CMAK
  - ì—˜ë¼ìŠ¤í‹±ì„œì¹˜
  - í‚¤ë°”ë‚˜
  - ëª¨ë‹ˆí„°ë§ ë„êµ¬
 
- **ì£¼í‚¤í¼**ëŠ” 1ê°œì˜ ì•™ìƒë¸”ë§Œ êµ¬ì„±í•˜ê³ , ì§€ë…¸ë“œë¥¼ ë¶„ë¦¬í•´ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° 2ê°œê°€ í•˜ë‚˜ì˜ ì£¼í‚¤í¼ ì•™ìƒë¸”ì„ ë°”ë¼ë³´ë„ë¡ êµ¬ì„±í•œë‹¤.
- **ì¹´í”„ì¹´ ì»¤ë„¥íŠ¸**ëŠ” ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì™€ ê°™ì´ ìœ„ì¹˜í•œë‹¤.
  - ë¯¸ëŸ¬ë§ ë™ì‘ì€ í”„ë¡œë“€ì„œ + ì»¨ìŠˆë¨¸ ë™ì‘ìœ¼ë¡œ ì´ë¤„ì§„ë‹¤.
  - ì—…ìŠ¤íŠ¸ë¦¼ê³¼ í•¨ê»˜ ìœ„ì¹˜í•  ê²½ìš°, í”„ë¡œë“€ì„œê°€ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ìƒí™©ì— ë…¸ì¶œë  ë•Œ ì¼ë¶€ ë©”ì‹œì§€ê°€ ìœ ì‹¤ë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.
  - ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ê³¼ í•¨ê»˜ ìœ„ì¹˜í•  ê²½ìš°, ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” í”„ë¡œë“€ì„œëŠ” ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ë™ì‘í•˜ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì¥ì• ëŠ” ê±°ì˜ ë°œìƒí•˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.
  - **í”„ë¡œë“€ì„œëŠ” ì»¨ìŠˆë¨¸ë³´ë‹¤ ë„¤íŠ¸ì›Œí¬ ì¥ì• ì— ë”ìš± ë¯¼ê°í•˜ë¯€ë¡œ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì™€ ê°€ê¹Œìš´ ìœ„ì¹˜ì— ë°°ì¹˜í•˜ëŠ” ê²ƒì´ ì¤‘ìš”**í•˜ë‹¤.
 
<br/>

```
cd kafka2/
cd chapter12/ansible_playbook
ansible-playbook -i hosts site.yml
ansible-playbook -i hosts exporter.yml
ansible-playbook -i hosts monitoring.yml
```
- ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ì¹˜í•œë‹¤.
- peter-ansible01 ì„œë²„ì— ì ‘ì†í•˜ì—¬ ê¹ƒí—ˆë¸Œ ì˜ˆì œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•´ë‘” ê²½ë¡œë¡œ ì´ë™ í›„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œë‹¤.
  - `site.yml`: ì£¼í‚¤í¼, ì¹´í”„ì¹´, ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬, ì¹´í”„ì¹´ ì»¤ë„¥íŠ¸ ë“±
  - `exporter.yml`: JMX, ë…¸ë“œ, ì¹´í”„ì¹´ ìµìŠ¤í¬í„° ë“±
  - `monitoring.yml`: ê·¸ë¼íŒŒë‚˜, í”„ë¡œë©”í…Œìš°ìŠ¤ ë“±
 
<br/>

## 12.3 ì—”í„°í”„ë¼ì´ì¦ˆìš© ì¹´í”„ì¹´ì˜ ìš´ì˜ ì‹¤ìŠµ

### 12.3.1 CMAKë¥¼ ì´ìš©í•œ í† í”½ ìƒì„±

1. CMAKì™€ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° ì—°ë™
   - `http://peter-kafka01.foo.bar:9000` ì£¼ì†Œë¡œ ì ‘ê·¼
   - Cluster ë“œë¡­ë‹¤ìš´ ë©”ë‰´ë¥¼ í´ë¦­í•´ Add Cluster ì„ íƒ
   - í´ëŸ¬ìŠ¤í„°ì˜ ìƒì„¸ ì •ë³´ ì…ë ¥
     - `Cluster Name`: kafka-1(ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´)
     - `Cluster Zookeeper Hosts`: peter-zk01.foo.bar:2181,peter-zk02.foo.bar:2181,peter-zk03.foo.bar:2181/kafka3
     - `Enable JMX Polling`: í™œì„±í™”
    
   - SAVE ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¤ì • ë§ˆë¬´ë¦¬
  
2. ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° `kafka-2` ì¶”ê°€(ì—°ë™)
   - `Cluster Name`: kafka-2(ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´)
   - `Cluster Zookeeper Hosts`: peter-zk01.foo.bar:2181,peter-zk02.foo.bar:2181,peter-zk03.foo.bar:2181/kafka4
  
3. kafka-1 í´ëŸ¬ìŠ¤í„°ì— í† í”½(ì‹¤ìŠµìš©) ìƒì„±
   - Cluster > List > kafka-1ì„ í´ë¦­í•´ `kafka-1`ì˜ ë©”ì¸ ë©”ë‰´ë¡œ ì´ë™
   - ìƒë‹¨ ë©”ë‰´ ì¤‘ Topicì„ í´ë¦­í•´ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì¤‘ Createë¥¼ ì„ íƒí•´ì„œ í† í”½ ìƒì„± ë©”ë‰´ë¡œ ì§„ì… (CMAKì˜ í† í”½ ìƒì„± ë©”ë‰´)
   - í† í”½ì˜ ìƒì„¸ ì˜µì…˜ ì„¤ì •
     - `Topic`: peter-avro01-kafka1
     - `Partitions`: 1
     - `Replication Factor`: 3
    
   - Create í´ë¦­
  
<br/>

### 12.3.2 ì¹´í”„ì¹´ ì»¤ë„¥íŠ¸ ì„¤ì •

```
$ curl --header "Content-Type: application/json" --header
"Accept: application/json" --request PUT --data '{
"name": "peter-mirrormaker2",
"connector.class": "org.apache.kafka.connect.mirror.MirrorSourceConnector", # ì»¤ë„¥í„°ì—ì„œ ì‚¬ìš©í•˜ëŠ” í´ë˜ìŠ¤ ì •ì˜
"tasks.max": "1",

# ì†ŒìŠ¤ í´ëŸ¬ìŠ¤í„°(src)ì™€ íƒ€ê¹ƒ í´ëŸ¬ìŠ¤íŠ¸(dst)ì˜ ì—ì¼ë¦¬ì–´ìŠ¤(ë³„ì¹­) ì§€ì •
"source.cluster.alias": "src",
"target.cluster.alias": "dst",

# ì†ŒìŠ¤ í´ëŸ¬ìŠ¤í„°ì™€ íƒ€ê¹ƒ í´ëŸ¬ìŠ¤í„°ì˜ ë¶€íŠ¸ìŠ¤íŠ¸ë© ì„œë²„ ë¦¬ìŠ¤íŠ¸ ì„¤ì •
"source.cluster.bootstrap.servers": "peter-kafka01.foo.bar:9092,peter-kafka02.foo.bar:9092,peter-kafka03.foo.bar:9092",
"target.cluster.bootstrap.servers": "peter-zk01.foo.bar:9092,peter-zk02.foo.bar:9092,peter-zk03.foo.bar:9092",

"replication.factor": "3", # íƒ€ê¹ƒ í´ëŸ¬ìŠ¤í„°ì˜ í† í”½ì„ ìƒì„±í•  ë•Œ ë¦¬í”Œë¦¬ì¼€ì´ì…˜ íŒ©í„° ìˆ˜(3) ì§€ì •
"topics": "peter-avro01-kafka1"
}' http://peter-zk01.foo.bar:8083/connectors/peter-mirrormaker2/config
```
- curl ëª…ë ¹ì–´ë¥¼ ì´ìš©í•œ ë¯¸ëŸ¬ ì†ŒìŠ¤ ì»¤ë„¥í„° ë“±ë¡
- `src.peter-avro01-kafka01` í† í”½ì´ ë¯¸ëŸ¬ ë©”ì´ì»¤ë¥¼ ì´ìš©í•´ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ `peter-avro01-kafka1` í† í”½ì„ ë¯¸ë¨¸ë§í•œë‹¤.

<br/>

### 12.3.3 ëª¨ë‹ˆí„°ë§ í™˜ê²½ êµ¬ì„±
- `http://peter-kafka01.foo.bar:3000`: ê·¸ë¼íŒŒë‚˜ ì ‘ê·¼
  - ì•„ì´ë””: admin
  - ë¹„ë°€ë²ˆí˜¸: admin
 
- í”„ë¡œë©”í…Œìš°ìŠ¤ ì—°ë™ (ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ ìƒì„± ì ˆì°¨ì™€ ë™ì¼)
  - `Name`: Prometheus
  - 'URL': http://peter-kafka01.foo.bar:9090
 
- ëŒ€ì‹œë³´ë“œ ìƒì„±
  - Kafka Metrics ëŒ€ì‹œë³´ë“œ(kafka_metrics.json)
  - Kafka Exporter Overview ëŒ€ì‹œë³´ë“œ(7589)
  - Node Exporter ëŒ€ì‹œë³´ë“œ(1860)
 
<br/>

### 12.3.4 ë©”ì‹œì§€ ì „ì†¡ê³¼ í™•ì¸

```
$ git clone https://github.com/onlybooks/kafka2
$ sudo yum -y install python3
$ python3 -m venv venv12
$ source venv12/bin/activate
$ pip install confluent-kafka[avro]
$ pip install names
$ pip install elasticsearch
```
- ë¼ì´ë¸ŒëŸ¬ë¦¬(confluent-kafka[avro], names, elasticsearch) ì„¤ì¹˜

<br/>

```python
# avro, names, random ê´€ë ¨ ëª¨ë“ˆ ì„í¬íŠ¸
from confluent_kafka import avro
from confluent_kafka.avro import AvroProducer
import names
import random

# ìŠ¤í‚¤ë§ˆ ì •ì˜
value_schema_str = """
{"namespace": "studnet.avro",
 "type": "record",
 "doc": "This is an example of Avro.",
 "name": "Student",
 "fields": [
   {"name": "name", "type": ["null", "string"], "default": null, "doc": "Name of the student"},
   {"name": "class", "type": "int", "default": 1, "doc": "Class of the student"}
 ]
}
"""

# ë°¸ë¥˜ ìŠ¤í‚¤ë§ˆ ì½”ë“œ
value_schema = avro.loads(value_schema_str)

# ì „ì†¡ ê²°ê³¼ í™•ì¸
def delivery_report(errm msg):
  """Called once for each message produced to indicate delivery result.
     Triggered by poll() or flush()."""
  if err is not None:
    print('Message delivery failed: {}'.format(err))
  else:
    print('Message dlivered to {} [{}]'.format(msg.topic(), msg.offset()))

# AvroProducer ì†ì„± ì •ì˜
avroProducer = AvroProducer({
  'bootstrap.servers': 'peter-kafka01.foo.bar,peter-kafka02.foo.bar,peter-kafka03.foo.bar',
  'on_delivery': delivery_report,
  'schema.registry.url': 'http://peter-kafka03.foo.bar:8081`
  }, default_value_schema=value_schema)

# ë©”ì‹œì§€ ì „ì†¡
for x in range(100):
  value = {"name": names.get_first_name(), "class": random.randint(1,5)} # ì „ì†¡í•  ë©”ì‹œì§€
  avroProducer.produce(topic='peter-avro01-kafka1', value=value)

avroProducer.flush()
```
ğŸ”¼ íŒŒì´ì¬ ì½”ë“œë¡œ ì‘ì„±í•œ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” íŒŒì´ì¬ í”„ë¡œë“€ì„œ ì˜ˆì œ(producer-1_kafka-1_v1.py)
- ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•œë‹¤.
  - í•™ìƒì˜ ì´ë¦„(name): ë¬¸ìí˜•(string)
  - í•™ìƒì´ ì†í•œ ë°˜(class): ì •ìˆ˜í˜•(int)
 
- í•™ìƒ ì´ë¦„ê³¼ ë°˜ì„ ëœë¤ìœ¼ë¡œ ìƒì„±í•´ ì´ 100ê°œì˜ ë°ì´í„°ë¥¼ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ peter-avro01-kafka1 í† í”½ìœ¼ë¡œ ì „ì†¡í•œë‹¤.

<br/>

```
$ python kafka2/chapter12/python/producer-1_kafka-1_v1.py
```
- í”„ë¡œë“€ì„œ íŒŒì¼ ì‹¤í–‰
- ì „ì†¡í•œ ë©”ì‹œì§€ëŠ” ê°€ì¥ ë¨¼ì € ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ `peter-avro01-kafka1`ë¡œ ì €ì¥ëœë‹¤.
- ì—…ìŠ¤íŠ¸ë¦¼ì˜ `peter-avro01-kafka1` í† í”½ì˜ ë©”ì‹œì§€ëŠ” **ë¯¸ëŸ¬ë§**ì„ í†µí•´ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ `src.peter-avro01-kafka1` í† í”½ì—ë„ ë™ì¼í•˜ê²Œ ì €ì¥ëœë‹¤.

<br/>

```python
# avro ê´€ë ¨ ëª¨ë“ˆ ì„í¬íŠ¸
from confluent_kafka import avro
from confluent_kafka.avro import AvroConsumer
from confluent_kafka.avro.serializer import SerializeError

# ìŠ¤í‚¤ë§ˆ ì •ì˜
value_schema_str = """
{"namespace": "studnet.avro",
 "type": "record",
 "doc": "This is an example of Avro.",
 "name": "Student",
 "fields": [
   {"name": "name", "type": ["null", "string"], "default": null, "doc": "Name of the student"},
   {"name": "class", "type": "int", "default": 1, "doc": "Class of the student"}
 ]
}
"""

# ë°¸ë¥˜ ìŠ¤í‚¤ë§ˆ ì½”ë“œ
value_schema = avro.loads(value_schema_str)

# AvroConsumer ì†ì„± ì •ì˜
c = AvroConsumer({
  'bootstrap.servers': 'peter-kafka01.foo.bar,peter-kafka02.foo.bar,peter-kafka03.foo.bar',
  'group.id': 'python-groupid01',
  'auto.offset.reset': 'earliest',
  'schema.registry.url': 'http://peter-kafka03.foo.bar:8081`
  }, reader_value_schema=value_schema)

# í† í”½ êµ¬ë…
c.subscribe(['peter-avro01-kafka1'])

# ë©”ì‹œì§€ ì»¨ìŠ˜
while True:
  try:
    msg = c.poll(10)

  except SerializerError as e:
    print("Message deserialization failed for {}: {}".format(msg, e))
    break

  if msg is None:
    continue

  if msg.error():
    print("AvroConsumer error: {}".format(msg.error()))
    continue

  print(msg.value())

# ì¢…ë£Œ
c.close()
```
ğŸ”¼ íŒŒì´ì¬ ì½”ë“œë¡œ ì‘ì„±í•œ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì—ì„œ ë©”ì‹œì§€ë¥¼ ì»¨ìŠ˜í•˜ëŠ” ì—ì´ë¸Œë¡œ ì»¨ìŠˆë¨¸(consumer-1_kafka-1_v1.py)
- í”„ë¡œë“€ì„œê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì˜ ì „ì†¡ëëŠ”ì§€ í™•ì¸í•œë‹¤.

<br/>

```
$ python kafka2/chapter12/python/consumer-1_kafka-1_v1.py
```
- ì»¨ìŠˆë¨¸ íŒŒì¼ ì‹¤í–‰
- í•™ìƒìœ¼ë¡œ ì •ì˜í•œ ìŠ¤í‚¤ë§ˆë¥¼ ì´ìš©í•´ í”„ë¡œë“€ì„œê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆê³ , ì»¨ìŠˆë¨¸ ì—­ì‹œ ì˜¤ë¥˜ ì—†ì´ ë©”ì‹œì§€ë¥¼ ì½ì„ ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br/>

```
$ curl -X GET 'http://peter-kafka02.foo.bar:9200/_cat/indices?v'
```
- ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì—ì„œ ì œê³µí•˜ëŠ” REST APIë¥¼ ì´ìš©í•´ **ì¸ë±ìŠ¤**ë¥¼ ì²´í¬í•œë‹¤.
  - `ë„íë¨¼íŠ¸`: ë°ì´í„° ë‹¨ìœ„
  - `ì¸ë±ìŠ¤`: ë„íë¨¼íŠ¸ë¥¼ ëª¨ì•„ë†“ì€ ê²ƒ
 
- ì¶œë ¥ ë‚´ìš©ì€ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¡œ ë¯¸ëŸ¬ë§ëœ ë©”ì‹œì§€ë“¤ì˜ ì „ì†¡ì´ ì´ë£¨ì–´ì§€ê¸° ì „ì´ë¯€ë¡œ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì˜ ë©”ë‰´ í•­ëª©ê³¼ ì¼ë¶€ ì¹´ë°”ë‚˜ ê´€ë ¨ ì¸ë±ìŠ¤ë“¤ë§Œ ì¶œë ¥ëœë‹¤.

<br/>

```python
# avro, elasticsearch ê´€ë ¨ ëª¨ë“ˆ ì„í¬íŠ¸
from confluent_kafka import avro
from confluent_kafka.avro import AvroConsumer
from confluent_kafka.avro.serializer import SerializerError
from elasticsearch import Elasticsearch
from datetime import datetime

# ìŠ¤í‚¤ë§ˆ ì •ì˜
value_schema_str = """
{"namespace": "studnet.avro",
 "type": "record",
 "doc": "This is an example of Avro.",
 "name": "Student",
 "fields": [
   {"name": "name", "type": ["null", "string"], "default": null, "doc": "Name of the student"},
   {"name": "class", "type": "int", "default": 1, "doc": "Class of the student"}
 ]
}
"""

# ë°¸ë¥˜ ìŠ¤í‚¤ë§ˆ ì½”ë“œ
value_schema = avro.loads(value_schema_str)

# AvroConsumer ì†ì„± ì •ì˜
c = AvroConsumer({
  'bootstrap.servers': 'peter-kafka01.foo.bar,peter-kafka02.foo.bar,peter-kafka03.foo.bar',
  'group.id': 'python-groupid01',
  'auto.offset.reset': 'earliest',
  'schema.registry.url': 'http://peter-kafka03.foo.bar:8081`
  }, reader_value_schema=value_schema)

# í† í”½ êµ¬ë…
c.subscribe(['src.peter-avro01-kafka1'])

# ES ì—°ê²°
es = Ealsticsearch('peter-kafka02.foo.bar:9092')
index = 'students'

# ë©”ì‹œì§€ ì»¨ìŠ˜ & ES ì „ì†¡
while True:
  try:
    msg = c.poll(10)

  expect SerializerError as e:
    print("Message deserialization failed for {}: {}".format(msg, e))
    break

  if msg in None:
    continue

  if msg.error():
    print("AvroConsumer error: {}".format(msg.error()))
    continue

  print(msg.value())
  doc = msg.value()
  doc['timestamp'] = datetime.now()

  if not es.indices.exists(index=index):
    es.indices.create(index=index)
  es.index(index=index, doc_type='_doc', body=doc)

# ì¢…ë£Œ
c.close()
```
ğŸ”¼ íŒŒì´ì¬ìœ¼ë¡œ ì‘ì„±í•œ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì—ì„œ ë©”ì‹œì§€ë¥¼ ì½ì–´ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¡œ ì „ì†¡í•˜ëŠ” ì»¨ìŠˆë¨¸(consumer_kafka-2_producer_es_v1.py)
- ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì—ì„œ ë¯¸ëŸ¬ë§ëœ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ `src.peter-avro01-kafka1` í† í”½ì—ì„œ ë©”ì‹œì§€ë¥¼ ì½ì€ ë’¤ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¡œ ì „ì†¡í•œë‹¤.

<br/>

```
$ python kafka2/chapter12/python/consumer_kafka-2_producer_es_v1.py
```
- ì»¨ìŠˆë¨¸(with ES)ë¥¼ ì‹¤í–‰í•œë‹¤.
- ì¶œë ¥ ê²°ê³¼ì—ì„œ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì—ì„œ ì½ì€ ë©”ì‹œì§€ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì—ì„œ ì œê³µí•˜ëŠ” REST APIë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ë±ìŠ¤ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ë©´ ì½ì–´ì˜¨ ë©”ì‹œì§€ê°€ ì˜ ì €ì¥ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br/>

<img alt="image" width="500" src="https://github.com/mash-up-kr/S3A/assets/55437339/7a741524-4cac-4b69-bae2-74a36e2d8625"/>

ğŸ”¼ ë©”ì‹œì§€ ì´ë™ ê²½ë¡œì™€ ë©”ì‹œì§€ ê±´ìˆ˜
- `í”„ë¡œë“€ì„œ-1`ì´ ë©”ì‹œì§€ 100ê±´ì„ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ì „ì†¡í–ˆë‹¤.
- ì „ì†¡ëœ ë©”ì‹œì§€ë“¤ì€ ë¯¸ëŸ¬ ë©”ì´ì»¤ë¥¼ í†µí•´ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ë¡œ ë‹¤ì‹œ ì „ì†¡ëë‹¤.
- ë©”ì‹œì§€ 100ê±´ì´ ì •í™•í•˜ê²Œ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì— ì €ì¥ëë‹¤.
- `ì»¨ìŠˆë¨¸-2`ë¥¼ í†µí•´ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì—ì„œ ë©”ì‹œì§€ë¥¼ ì»¨ìŠ˜í•˜ì—¬ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¡œ ì „ì†¡í–ˆë‹¤.
- ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì˜ ìµœì¢… ë©”ì‹œì§€ ìˆ˜ê°€ 100ê±´ì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- âœ¨ ì¶œë°œì§€ë¶€í„° ìµœì¢… ëª©ì ì§€ê¹Œì§€ ì¤‘ê°„ì— í•˜ë‚˜ì˜ ë©”ì‹œì§€ë„ ìœ ì‹¤ ì—†ì´ ëª¨ë‘ ì˜ ì „ì†¡ëë‹¤.

<br/>

> **í‚¤ë°”ë‚˜, ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì—°ë™**

- `http://peter-kafka-2.foo.bar:5601` ì ‘ê·¼ (í‚¤ë°”ë‚˜ì˜ ìµœì´ˆ ì ‘ê·¼ í™”ë©´)
- `Explore on my own` í´ë¦­
- ì¸ë±ìŠ¤ ì¶”ê°€ (ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì— ì €ì¥ëœ ë©”ì‹œì§€ë¥¼ í‚¤ë°”ë‚˜ì—ì„œ ë³¼ ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•¨)
  - `Manage` í´ë¦­ (ìš°ì¸¡ ìƒë‹¨)
  - `Index Patterns` ì„ íƒ (ì¢Œì¸¡ ë©”ë‰´)
  - `Create index pattern` í´ë¦­
  - ìƒì„±í•˜ê³ ì í•˜ëŠ” ì¸ë±ìŠ¤ íŒ¨í„´ ì •ì˜
    - `Index pattern name`: students*
    - Next step
   
  - ì¸ë±ìŠ¤ íŒ¨í„´ì˜ íƒ€ì„ í•„ë“œ ì§€ì •
    - `Time field`ì˜ ë©”ë‰´ ë°•ìŠ¤ì—ì„œ timestamp ì„ íƒ
    - Create index pattern
   
- `Anaytics > Discover` í´ë¦­ (ë©”ë‰´ë°”)
  - 100 ìˆ«ì í™•ì¸ ê°€ëŠ¥ (ë°ì´í„° ìˆ˜)
  - ë„íë¨¼íŠ¸ë“¤ì˜ ìƒì„¸ ë‚´ìš© í™•ì¸ ê°€ëŠ¥ (name, class ë¹„êµ)
 
<br/>

```python

```
ğŸ”¼ ì „í™”ë²ˆí˜¸ì™€ ë‚˜ì´ë¥¼ ì¶”ê°€í•œ ìŠ¤í‚¤ë§ˆë¡œ ì—…ìŠ¤íŠ¸ë¦¼ ì¹´í”„ì¹´ì˜ ë©”ì‹œì§€ë¥¼ ì½ëŠ” ì»¨ìŠˆë¨¸(consumer-1_kafka-1_v2.py)
